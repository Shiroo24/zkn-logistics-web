<div xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{layout}">

    <div layout:fragment="content">
        <div class="d-flex justify-content-between align-items-end mb-4 bg-white p-4 rounded-4 shadow-sm border">
            <div>
                <span class="badge bg-primary mb-2 px-3 py-2 rounded-pill fw-bold" style="font-size: 0.65rem;">
                    <i class="fa-solid fa-truck-fast me-1 text-white"></i> LOGISTIC MONITORING
                </span>
                <h3 class="fw-bold mb-0 text-dark">Data Resi Pengiriman</h3>
                <small class="text-muted fw-semibold">Dashboard Utama / <span class="text-danger" th:text="${activeTab}"></span></small>
            </div>

            <div class="text-end">
                <h6 class="mb-0 fw-bold text-dark" style="font-size: 0.85rem;">Total Records</h6>
                <div class="h4 mb-0 fw-black text-danger" id="totalCount" th:text="${dataResi.size()}">0</div>
            </div>
        </div>

        <div class="card border-0 bg-transparent mb-3">
            <ul class="nav nav-pills gap-2 flex-nowrap overflow-auto pb-2" id="resitab">
                <li class="nav-item" th:each="tabName : ${ {'INSTANT', 'SHOPEE EXPRESS', 'J&T', 'JNE', 'ANTER AJA'} }">
                    <a class="nav-link rounded-pill border fw-bold px-4 py-2"
                       style="font-size: 0.8rem; transition: 0.3s;"
                       th:classappend="${activeTab == tabName ? 'active bg-danger border-danger text-white' : 'bg-white text-secondary'}"
                       th:href="@{/resiscreen(tab=${tabName})}"
                       th:text="${tabName}"></a>
                </li>
            </ul>
        </div>

        <div class="card p-3 mb-4 border-0 shadow-sm rounded-4 bg-white">
            <div class="row g-3">
                <div class="col-md-5">
                    <div class="search-container position-relative">
                        <i class="fa fa-search position-absolute text-muted" style="top: 13px; left: 15px;"></i>
                        <input type="text" id="globalSearch" class="form-control ps-5 border-light rounded-pill"
                               style="height: 45px; background: #f8fafc;" placeholder="Cari resi, notes, atau ID...">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-light rounded-start-pill px-3" style="height: 45px;">
                            <i class="fa fa-calendar-alt text-muted"></i>
                        </span>
                        <input type="text" id="dateRange" class="form-control border-light rounded-end-pill px-3"
                               style="height: 45px; background: #f8fafc;" placeholder="Filter Rentang Tanggal">
                    </div>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-dark w-100 rounded-pill fw-bold" style="height: 45px;" onclick="exportTableToExcel()">
                        <i class="fa fa-file-excel me-2"></i> EXPORT DATA
                    </button>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-white">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="erpTable">
                    <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-secondary" style="font-size: 0.7rem; letter-spacing: 1px;">ID</th>
                        <th class="py-3 text-secondary" style="font-size: 0.7rem; letter-spacing: 1px;">DEPARTURE DATE</th>
                        <th class="py-3 text-secondary" style="font-size: 0.7rem; letter-spacing: 1px;">RESI</th>
                        <th class="py-3 text-secondary" style="font-size: 0.7rem; letter-spacing: 1px;">LAYANAN</th>
                        <th class="pe-4 py-3 text-secondary text-end" style="font-size: 0.7rem; letter-spacing: 1px;">EKESPEDISI/NAMA KURIR</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="r : ${dataResi}" class="resi-row" style="transition: 0.2s; display: none;">
                        <td class="ps-4 small text-muted font-monospace" th:text="${r.uniqueId}"></td>
                        <td class="date-cell fw-bold text-dark" th:text="${r.date}"></td>
                        <td><span class="badge bg-light text-primary border px-3 py-2 rounded-pill fw-bold" th:text="${r.resi}"></span></td>
                        <td><span class="badge bg-opacity-10 px-3 py-2 rounded-2 text-danger bg-danger border border-danger border-opacity-25"
                                  style="font-size: 0.75rem;" th:text="${r.notes}"></span></td>
                        <td class="pe-4 text-end">
                                <span class="badge bg-white text-dark border px-3 py-2 rounded-pill shadow-sm">
                                    <i class="fa-solid fa-circle-check text-success me-1"></i>
                                    <span th:text="${r.ekspedisi}"></span>
                                </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="d-flex justify-content-center mt-4">
            <nav id="paginationNav">
                <ul class="pagination pagination-sm gap-1" id="paginationList">
                </ul>
            </nav>
        </div>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

        <script>
            let rowsPerPage = 50;
            let currentPage = 1;
            const tableRows = document.querySelectorAll('.resi-row');
            const paginationList = document.getElementById('paginationList');

            function displayPage(page) {
                currentPage = page;
                let start = (page - 1) * rowsPerPage;
                let end = start + rowsPerPage;

                tableRows.forEach((row, index) => {
                    row.style.display = (index >= start && index < end) ? '' : 'none';
                });

                updatePaginationButtons();
            }

            function updatePaginationButtons() {
                let pageCount = Math.ceil(tableRows.length / rowsPerPage);
                paginationList.innerHTML = '';

                // Jika data sedikit, tidak perlu pagination
                if (pageCount <= 1) return;

                for (let i = 1; i <= pageCount; i++) {
                    let li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link rounded-3 border-0 fw-bold shadow-sm ${i === currentPage ? 'bg-danger text-white' : 'bg-white text-dark'}"
                                    href="javascript:void(0)" onclick="displayPage(${i})">${i}</a>`;
                    paginationList.appendChild(li);
                }
            }

            // Init awal
            displayPage(1);

            // Search Logic (Global)
            document.getElementById('globalSearch').addEventListener('keyup', function() {
                let val = this.value.toLowerCase();
                const nav = document.getElementById('paginationNav');

                if (val === "") {
                    nav.style.display = ''; // Tampilkan pagination lagi
                    displayPage(1);
                } else {
                    nav.style.display = 'none'; // Sembunyikan pagination saat mencari
                    tableRows.forEach(row => {
                        row.style.display = row.innerText.toLowerCase().includes(val) ? '' : 'none';
                    });
                }
            });

            // Flatpickr & Filter Date
            flatpickr("#dateRange", {
                mode: "range",
                dateFormat: "d/m/Y",
                onClose: function(selectedDates) {
                    if (selectedDates.length === 2) filterByDateRange(selectedDates[0], selectedDates[1]);
                }
            });

            function filterByDateRange(start, end) {
                document.getElementById('paginationNav').style.display = 'none';
                tableRows.forEach(row => {
                    let dateStr = row.querySelector(".date-cell").innerText.trim();
                    let parts = dateStr.split(' ')[0].split('/');
                    if(parts.length < 3) return;
                    let rowDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    start.setHours(0,0,0,0); end.setHours(23,59,59,999);
                    row.style.display = (rowDate >= start && rowDate <= end) ? '' : 'none';
                });
            }

            function exportTableToExcel() {
                let csv = [];
                let rows = document.querySelectorAll("table tr");
                for (let i = 0; i < rows.length; i++) {
                    let row = [], cols = rows[i].querySelectorAll("td, th");
                    for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText + '"');
                    csv.push(row.join(","));
                }
                let csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
                let downloadLink = document.createElement("a");
                downloadLink.download = "ZKN_Log_Export.csv";
                downloadLink.href = window.URL.createObjectURL(csvFile);
                downloadLink.click();
            }
        </script>

        <style>
            #erpTable tbody tr:hover {
                background-color: #f8fafc !important;
                transform: scale(1.002);
                box-shadow: inset 4px 0 0 0 #EF4444;
            }
            .nav-link.active {
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            }
            .page-link {
                padding: 8px 16px;
                transition: 0.2s;
            }
            .page-item.active .page-link {
                z-index: 3;
            }
        </style>
    </div>
</div>